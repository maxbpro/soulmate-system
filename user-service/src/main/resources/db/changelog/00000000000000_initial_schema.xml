<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="changeset01" author="mbuyanov">
        <sql>
            CREATE SCHEMA IF NOT EXISTS profile;
            CREATE SCHEMA IF NOT EXISTS profile_service_history;
            CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
            SET search_path TO profile,profile_service_history,public;

            CREATE TABLE profile.profiles
            (
                id            UUID          PRIMARY KEY,
                active        BOOLEAN       NOT NULL DEFAULT TRUE,
                created       TIMESTAMPTZ   NOT NULL,
                updated       TIMESTAMPTZ   NOT NULL,
                email         VARCHAR(64)   NOT NULL UNIQUE,
                phone_number  VARCHAR(16)   NOT NULL,
                first_name    VARCHAR(64)   NOT NULL,
                last_name     VARCHAR(64)   NOT NULL,
                birth_date    DATE          NOT NULL,
                radius        INTEGER       NOT NULL DEFAULT 10,
                age_min       INTEGER       NOT NULL DEFAULT 18,
                age_max       INTEGER       NOT NULL DEFAULT 99,
                gender        VARCHAR(64)   NOT NULL,
                interested_in VARCHAR(64)   NOT NULL,
                photos        VARCHAR(64)[],
                landmarks     VARCHAR(5000) NOT NULL
            );

            CREATE TABLE profile_service_history.revinfo
            (
                rev       BIGSERIAL PRIMARY KEY,
                revtmstmp BIGINT
            );

            CREATE TABLE profile_service_history.profiles_history
            (
                id            UUID          NOT NULL,
                revision      BIGINT        NOT NULL,
                revision_type SMALLINT      NOT NULL,
                active        BOOLEAN       NOT NULL DEFAULT TRUE,
                email         VARCHAR(64)   NOT NULL,
                phone_number  VARCHAR(16)   NOT NULL,
                first_name    VARCHAR(64)   NOT NULL,
                last_name     VARCHAR(64)   NOT NULL,
                birth_date    DATE          NOT NULL,
                radius        INTEGER       NOT NULL DEFAULT 10,
                age_min       INTEGER       NOT NULL DEFAULT 18,
                age_max       INTEGER       NOT NULL DEFAULT 99,
                gender        VARCHAR(64)   NOT NULL,
                interested_in VARCHAR(64)   NOT NULL,
                photos        VARCHAR(64)[],
                landmarks     VARCHAR(5000) NOT NULL,

                CONSTRAINT pk_profiles_history PRIMARY KEY (id, revision),
                CONSTRAINT fk_profiles_history_rev FOREIGN KEY (revision) REFERENCES profile_service_history.revinfo (rev)
            );

            CREATE TABLE profile.outbox
            (
                id            UUID PRIMARY KEY,
                aggregatetype VARCHAR(255) NOT NULL,
                aggregateid   VARCHAR(255) NOT NULL,
                type          VARCHAR(255) NOT NULL,
                payload       JSONB        NOT NULL,
                created       TIMESTAMPTZ   NOT NULL
            );

        </sql>
    </changeSet>

</databaseChangeLog>